<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="theme-color" content="#0d0f14" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>MindAR è¡Œå‹•ç‰ˆç¯„ä¾‹ï¼ˆåœ–åƒè¿½è¹¤ + æˆªåœ–ï¼‰</title>

  <!-- å­—é«”ï¼ˆå¯æ›¿æ›ï¼‰ -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <!-- A-Frame èˆ‡ MindARï¼ˆé–å®šç‰ˆæœ¬ï¼‰ -->
  <script defer src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    :root{
      --bg:#0b0e14;
      --panel:#111520cc;
      --panel-solid:#141a24;
      --text:#e8f0ff;
      --muted:#9fb0c7;
      --brand:#4ea1ff;
      --brand-2:#7c4dff;
      --ok:#35d07f;
      --warn:#ffb02e;
      --err:#ff5d5d;
      --radius:14px;
      --blur:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;background:var(--bg);color:var(--text);margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;-webkit-tap-highlight-color:transparent}
    .app{
      position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;
      background: radial-gradient(130% 90% at 20% 10%, #0b1530 0%, #0b0e14 40%, #0b0e14 100%);
      padding:clamp(12px,5vw,24px); padding-bottom: max(16px, env(safe-area-inset-bottom));
    }
    .card{
      width:min(680px,92vw);
      background:linear-gradient(180deg,#141a24 0%,#0e131b 100%);
      border:1px solid #1f2a3a; border-radius:var(--radius); padding:24px;
      box-shadow:0 10px 30px #0009;
    }
    h1{margin:0 0 10px;font-size:clamp(20px,4.7vw,28px);font-weight:600;letter-spacing:.2px}
    p{margin:0;color:var(--muted);line-height:1.6}
    .cta{
      display:flex;gap:12px;flex-wrap:wrap;margin-top:16px
    }
    .btn{
      -webkit-appearance:none;appearance:none;cursor:pointer;
      border:none;border-radius:12px;padding:14px 18px;font-weight:600;font-size:16px;
      color:#06101f;background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
      box-shadow:0 8px 24px #4ea1ff40, inset 0 1px 0 #ffffff50; transition:transform .08s ease, filter .15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.sec{
      background:#1a2330;color:var(--text);box-shadow: inset 0 0 0 1px #2b3a4f;
    }
    .hint{display:flex;gap:10px;align-items:flex-start;margin-top:10px;color:var(--muted);font-size:14px}
    .badge{padding:4px 8px;border-radius:999px;background:#182232;border:1px solid #2b3a4f;color:#a9c4ff;font-size:12px}

    /* AR å®¹å™¨èˆ‡æµ®å‹•å·¥å…·åˆ— */
    .stage{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;
      opacity:0;pointer-events:none;transition:opacity .25s ease;
    }
    .stage.active{opacity:1;pointer-events:auto}
    .toolbar{
      position:fixed;inset:0;pointer-events:none;
    }
    .bar{
      position:absolute;left:0;right:0;display:flex;justify-content:space-between;align-items:center;
      padding:10px 14px;gap:8px;pointer-events:auto;
    }
    .bar.top{top: env(safe-area-inset-top); padding-top: max(6px, env(safe-area-inset-top))}
    .bar.bottom{bottom: env(safe-area-inset-bottom); padding-bottom: max(8px, env(safe-area-inset-bottom))}
    .glass{
      background:var(--panel);backdrop-filter: blur(var(--blur));
      border:1px solid #1d2736; border-radius:16px; box-shadow:0 10px 30px #0006; padding:8px;
    }
    .grp{display:flex;gap:8px}
    .iconbtn{
      display:inline-flex;align-items:center;gap:8px;
      background:#121a26;border:1px solid #223047;color:#dfe9ff;
      border-radius:12px;padding:10px 12px;font-weight:600;font-size:14px;cursor:pointer;
      box-shadow: inset 0 0 0 1px #1f2a3a; transition: filter .15s ease, transform .08s ease;
    }
    .iconbtn.primary{background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%); color:#06101f;border-color:transparent}
    .iconbtn.green{background: linear-gradient(135deg, #34d399 0%, #10b981 100%); color:#062b1c}
    .iconbtn.red{background: linear-gradient(135deg, #ff7676 0%, #ff5151 100%); color:#2b0505}
    .icon{width:18px;height:18px;display:inline-block}
    .small{font-size:12px;color:var(--muted);margin-left:8px}

    /* é™ç´šç›¸æ©Ÿæ¨¡å¼ */
    .fallback{
      position:fixed;inset:0;background:#000;display:none;align-items:center;justify-content:center;
    }
    .fallback.active{display:flex}
    #fallbackVideo{width:100%;height:100%;object-fit:cover}

    /* æç¤º/åå¸ */
    .toast{
      position:fixed;left:50%;bottom:calc(20px + env(safe-area-inset-bottom));transform:translateX(-50%);
      background:#0e141f;border:1px solid #223047;color:#dfe9ff;border-radius:12px;padding:10px 14px;
      opacity:0;pointer-events:none;transition:opacity .25s ease;
    }
    .toast.show{opacity:1}
    .status{font-size:13px;color:#a4b5cc}

    /* A-Frame ç½®é ‚ */
    a-scene{position:fixed !important;inset:0 !important}
  </style>
</head>
<body>
  <div class="app" id="home">
    <div class="card">
      <div class="badge">MindAR + Aâ€‘Frameï¼ˆè¡Œå‹•è£ç½®ï¼‰</div>
      <h1>å½±åƒè¿½è¹¤ ARï¼ˆå¾Œé¡é ­ã€å½±ç‰‡/åœ–ç‰‡è¦†å±¤ã€å¯æˆªåœ–ï¼‰</h1>
      <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²å…¥ ARã€‚æˆ‘å€‘æœƒå…ˆè«‹æ±‚å¿…è¦æ¬Šé™ï¼ˆç›¸æ©Ÿã€å‹•ä½œæ„Ÿæ¸¬ã€è¢å¹•å¸¸äº®ï¼‰ä¸¦ä½¿ç”¨å¾Œé¡é ­ã€‚è‹¥è£ç½®ä¸æ”¯æ´ï¼Œæœƒè‡ªå‹•é™ç´šåˆ°ç´”ç›¸æ©Ÿæ¨¡å¼ï¼Œä¾ç„¶å¯ä»¥æˆªåœ–ã€‚</p>
      <div class="hint">æ¸¬è©¦åœ–åƒï¼ˆç”¨å¦ä¸€å°è£ç½®é–‹ï¼‰ï¼š&nbsp;<a href="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.2/examples/assets/card/card.png" target="_blank">card.png</a></div>
      <div class="cta">
        <button class="btn" id="enterBtn">é€²å…¥ AR</button>
        <button class="btn sec" id="howBtn">å¦‚ä½•éƒ¨ç½²</button>
      </div>
      <div class="hint">
        <span class="status">è¨»ï¼šç›¸æ©Ÿéœ€ HTTPS æˆ– localhostï¼ˆiOS/Android å®‰å…¨é™åˆ¶ï¼‰ã€‚</span>
      </div>
    </div>
  </div>

  <!-- AR å ´æ™¯ -->
  <div class="stage" id="stage">
    <!-- æµ®å‹•å·¥å…·åˆ— -->
    <div class="toolbar">
      <div class="bar top">
        <div class="glass grp">
          <button class="iconbtn" id="helpBtn">
            <span class="icon">â“</span>èªªæ˜
          </button>
          <div class="small" id="statusText">å°±ç·’</div>
        </div>
        <div class="grp">
          <button class="iconbtn red" id="exitBtn"><span class="icon">âœ–</span>é›¢é–‹</button>
        </div>
      </div>
      <div class="bar bottom">
        <div class="grp"></div>
        <div class="grp glass">
          <button class="iconbtn primary" id="saveBtn"><span class="icon">ğŸ“¸</span>å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- A-Frame + MindARï¼ˆé è¨­é€æ˜èƒŒæ™¯ï¼Œä¿ç•™ç¹ªåœ–ç·©è¡æ–¹ä¾¿æˆªåœ–ï¼‰ -->
    <a-scene
      id="arScene"
      embedded
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: true"
      renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true; antialias: true; preserveDrawingBuffer: true"
      background="transparent: true"
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.2/examples/assets/card/targets.mind; filterMinCF: 0.0001; filterBeta: 0.01;"
      color-space="sRGB">
      <a-assets timeout="120000">
        <!-- è¦†å±¤åœ–ç‰‡ï¼ˆå¯æ›ä½ çš„åœ–ï¼‰ -->
        <img id="overlayImage" crossorigin="anonymous"
             src="https://images.unsplash.com/photo-1519681393784-d120267933ba?w=1200&q=80&auto=format&fit=crop" />
        <!-- è¦†å±¤å½±ç‰‡ï¼ˆå¯æ›ä½ çš„å½±ç‰‡ï¼›ç‚ºäº†è¡Œå‹•è‡ªå‹•æ’­æ”¾ï¼Œéœ€ muted + playsinlineï¼‰ -->
        <video id="overlayVideo" crossorigin="anonymous" muted playsinline loop preload="auto"
               src="https://cdn.coverr.co/videos/coverr-colourful-ink-1036/1080p.mp4"></video>
        <!-- é ç•™ 3D æ¨¡å‹ï¼ˆéœ€è¦æ™‚æŠŠ visible è¨­ç‚º true ä¸¦æŒ‡å®šä½ çš„ .glb/.gltfï¼‰ -->
        <!-- <a-asset-item id="modelAsset" src="your-model.glb"></a-asset-item> -->
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- ç›®æ¨™ 0ï¼šç•¶åµæ¸¬åˆ°æŒ‡å®šåœ–ç‰‡æ™‚é¡¯ç¤ºè¦†å±¤ -->
      <a-entity mindar-image-target="targetIndex: 0">
        <!-- è¦†å±¤åœ–ç‰‡å¹³é¢ -->
        <a-plane src="#overlayImage"
                 position="0 0 0"
                 rotation="0 0 0"
                 width="1"
                 height="0.62"
                 material="shader: flat; opacity: 0.98;">
        </a-plane>

        <!-- è¦†å±¤å½±ç‰‡å¹³é¢ï¼ˆç¨å¾®æµ®åœ¨ä¸Šå±¤ 0.01ï¼‰ -->
        <a-video src="#overlayVideo"
                 position="0 -0.05 0.01"
                 rotation="0 0 0"
                 width="1"
                 height="0.56"
                 material="shader: flat;">
        </a-video>

        <!-- é ç•™ 3D æ¨¡å‹æ’æ§½ï¼ˆé è¨­é—œé–‰ï¼‰ -->
        <a-entity id="modelSlot" visible="false"
                  position="0 0 0.08" rotation="0 0 0"
                  scale="0.3 0.3 0.3">
          <!-- å•Ÿç”¨æ™‚åŠ ä¸Š gltf-model="#modelAsset" -->
        </a-entity>
      </a-entity>
    </a-scene>
  </div>

  <!-- é™ç´šï¼šç´”ç›¸æ©Ÿæ¨¡å¼ï¼ˆAR å¤±æ•—æˆ–ä¸æ”¯æ´æ™‚ï¼‰ -->
  <div class="fallback" id="fallback">
    <video id="fallbackVideo" autoplay playsinline muted></video>
    <div class="toolbar">
      <div class="bar top">
        <div class="glass grp">
          <div class="small">é™ç´šç›¸æ©Ÿæ¨¡å¼ï¼ˆä»å¯æˆªåœ–ï¼‰</div>
        </div>
        <div class="grp">
          <button class="iconbtn red" id="exitBtn2"><span class="icon">âœ–</span>é›¢é–‹</button>
        </div>
      </div>
      <div class="bar bottom">
        <div class="grp"></div>
        <div class="grp glass">
          <button class="iconbtn green" id="saveBtn2"><span class="icon">ğŸ“¸</span>å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å°åå¸ -->
  <div class="toast" id="toast">å·²å„²å­˜åˆ°ç›¸ç°¿ï¼ˆè‹¥æœªè‡ªå‹•ä¸‹è¼‰ï¼Œå°‡åœ¨æ–°åˆ†é é–‹å•Ÿåœ–ç‰‡ï¼Œå¯é•·æŒ‰å„²å­˜ï¼‰</div>

  <script>
    // =========== å¯èª¿æ•´è¨­å®šï¼ˆé›†ä¸­ç®¡ç†ï¼‰ ===========
    const CONFIG = {
      // MindAR æ¨™é¶ï¼ˆç¤ºç¯„ç”¨ï¼‰èˆ‡æ¸¬è©¦åœ– URLï¼ˆç”¨å¦ä¸€å°è£ç½®é–‹ï¼‰
      targetMind: 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.2/examples/assets/card/targets.mind',
      targetImageForUser: 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.2/examples/assets/card/card.png',
      // è¢å¹•æˆªåœ–æª”å
      screenshotName: 'ar-capture.png',
      // å½±ç‰‡è‡ªå‹•æ’­æ”¾ç­–ç•¥ï¼ˆå»ºè­° trueï¼›è‹¥ä½ è¦è²éŸ³ï¼Œè«‹åœ¨äº’å‹•å¾Œæ‰‹å‹•æ’­æ”¾ä¸¦ç§»é™¤ mutedï¼‰
      autoplayOverlayVideo: true,
    };

    // =========== å…¨åŸŸç‹€æ…‹ ===========
    let wakeLock = null;
    let preGrantedDeviceId = null;     // å‰ç½®æ¬Šé™æµç¨‹é¸åˆ°çš„ç›¸æ©Ÿ IDï¼ˆé™ç´šæ¨¡å¼ç”¨ï¼‰
    let activeFallbackStream = null;   // é™ç´šæ¨¡å¼ä¸²æµ
    let sceneCanvas = null;            // A-Frame WebGL ç•«å¸ƒ
    let stageActive = false;

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    function toast(msg, dur = 2000){
      const t = $('#toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), dur);
    }

    function setStatus(msg){
      $('#statusText').textContent = msg;
    }

    function isSecureContextOk(){
      return (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1');
    }

    function hasWebGL2(){
      try{ const c = document.createElement('canvas'); return !!(c.getContext('webgl2') || c.getContext('experimental-webgl2')); }
      catch(e){ return false; }
    }

    async function requestMotionPermissionIfNeeded(){
      // iOS 13+ éœ€è¦äº’å‹•æ‰‹å‹¢ä¸‹ä¸»å‹•è¦æ±‚
      const any = window.DeviceMotionEvent || window.DeviceOrientationEvent;
      const dm = window.DeviceMotionEvent;
      const doevt = window.DeviceOrientationEvent;
      try{
        if (typeof dm?.requestPermission === 'function'){
          await dm.requestPermission().catch(()=>{});
        }
        if (typeof doevt?.requestPermission === 'function'){
          await doevt.requestPermission().catch(()=>{});
        }
      }catch(e){
        // å¯å¿½ç•¥ï¼›MindAR å°å½±åƒè¿½è¹¤ä¸ä¸€å®šéœ€è¦
      }
    }

    async function requestWakeLock(){
      try{
        if ('wakeLock' in navigator){
          wakeLock = await navigator.wakeLock.request('screen');
          document.addEventListener('visibilitychange', async ()=>{
            if (document.visibilityState === 'visible' && !wakeLock){
              try{ wakeLock = await navigator.wakeLock.request('screen'); }catch{}
            }
          });
          wakeLock.addEventListener?.('release', ()=>{ wakeLock = null; });
        }
      }catch(e){ /* æŸäº›è£ç½®ä¸æ”¯æ´æˆ–ä½¿ç”¨è€…æ‹’çµ• */ }
    }

    async function preflightCamera(){
      // ç¬¬ä¸€å±¤ä¿éšªï¼šä¸»å‹•ä»¥ environment å˜—è©¦ï¼Œå¤±æ•—å†åˆ—èˆ‰è£ç½®æ‰¾å¾Œé¡é ­
      const tryGet = async (constraints) => {
        const s = await navigator.mediaDevices.getUserMedia(constraints);
        const track = s.getVideoTracks()[0];
        const settings = track.getSettings ? track.getSettings() : {};
        preGrantedDeviceId = settings.deviceId || null;
        // ç«‹å³åœæ­¢ï¼Œè®“ MindAR å¾ŒçºŒæ¥æ‰‹ï¼›æ¬Šé™å·²æˆäºˆï¼Œæ‰€ä»¥ä¸å†å½ˆçª—
        s.getTracks().forEach(t=>t.stop());
        return true;
      };

      // å…ˆå˜—è©¦å¾Œé¡é ­ï¼ˆidealï¼‰
      try{
        await tryGet({video:{ facingMode: {ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} }, audio:false});
        return true;
      }catch(e){ /* ç¹¼çºŒåˆ—èˆ‰ */ }

      // åˆ—èˆ‰è£ç½®ï¼Œæ‰¾åç¨±åŒ…å« back/rear çš„ç›¸æ©Ÿ
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videos = devices.filter(d=>d.kind==='videoinput');
        let back = videos.find(v => /back|rear|environment/i.test(v.label));
        if (!back && videos.length) back = videos[videos.length-1]; // é€€è€Œæ±‚å…¶æ¬¡
        if (back){
          await tryGet({video:{ deviceId:{exact: back.deviceId}, width:{ideal:1280}, height:{ideal:720} }, audio:false});
          return true;
        }
      }catch(e){ /* ç¹¼çºŒä¸‹ä¸€æ­¥ */ }

      // æœ€å¾Œå†è©¦æ™®é€šç›¸æ©Ÿ
      try{
        await tryGet({video:true, audio:false});
        return true;
      }catch(e){
        throw new Error('ç„¡æ³•å–å¾—ç›¸æ©Ÿæ¬Šé™ï¼š' + (e?.message || e));
      }
    }

    function getMindARCameraVideo(){
      // å˜—è©¦å¾ MindAR ç³»çµ±å–ï¼Œå¦å‰‡æƒæé é¢ä¸Šçš„ video å…ƒç´ ï¼ˆsrcObject ç‚º MediaStream ä¸” mutedï¼‰
      const sceneEl = $('#arScene');
      let fromSystem = null;
      try{
        const sys = sceneEl.systems && sceneEl.systems['mindar-image-system'];
        if (sys && sys.video) fromSystem = sys.video;
      }catch(e){}
      if (fromSystem) return fromSystem;

      const candidates = $$('video').filter(v => v.srcObject instanceof MediaStream);
      // éæ¿¾æ‰ overlayVideoï¼ˆå®ƒä¸æ˜¯ MediaStreamï¼‰
      return candidates[0] || null;
    }

    function getSceneCanvas(){
      const sceneEl = $('#arScene');
      return sceneEl?.canvas || null;
    }

    async function startAR(){
      // é¡¯ç¤ºå ´æ™¯
      $('#home').style.display = 'none';
      $('#stage').classList.add('active');
      stageActive = true;
      setStatus('åˆå§‹åŒ–ä¸­â€¦');

      // ç¬¬äºŒå±¤ä¿éšªï¼šè‹¥ WebGL2 ç¼ºå¤±ï¼Œç›´æ¥é™ç´š
      if (!hasWebGL2()){
        setStatus('æ­¤è£ç½®ä¸æ”¯æ´ WebGL2ï¼Œä½¿ç”¨é™ç´šç›¸æ©Ÿæ¨¡å¼');
        await startFallbackCamera();
        return;
      }

      const sceneEl = $('#arScene');

      // ç­‰å¾… A-Frame å ´æ™¯å®Œæˆå»ºç«‹ï¼ˆæ‰æ‹¿å¾—åˆ° canvasï¼‰
      if (!sceneEl.hasLoaded){
        await new Promise(res => sceneEl.addEventListener('loaded', res, {once:true}));
      }
      sceneCanvas = getSceneCanvas();

      // MindAR äº‹ä»¶ç›£è½
      sceneEl.addEventListener('arReady', ()=>{
        setStatus('AR å°±ç·’ï¼Œå°æº–æ¸¬è©¦åœ–å°±æœƒå‡ºç¾è¦†å±¤');
        // è‡ªå‹•æ’­æ”¾è¦†å±¤å½±ç‰‡ï¼ˆè¡Œå‹•ç«¯éœ€åœ¨ä½¿ç”¨è€…äº’å‹•å¾ŒåŸ·è¡Œï¼‰
        if (CONFIG.autoplayOverlayVideo){
          const v = $('#overlayVideo');
          v?.play().catch(()=>{ /* è‹¥è¢«ç€è¦½å™¨é˜»æ“‹ï¼Œå¯æ”¹ç‚ºé¡¯ç¤ºæ’­æ”¾æŒ‰éˆ• */ });
        }
      });
      sceneEl.addEventListener('arError', async (e)=>{
        console.warn('MindAR å•Ÿå‹•å¤±æ•—ï¼š', e);
        toast('AR å•Ÿå‹•å¤±æ•—ï¼Œåˆ‡æ›åˆ°é™ç´šç›¸æ©Ÿæ¨¡å¼');
        await startFallbackCamera();
      });

      setStatus('ç›¸æ©Ÿå•Ÿå‹•ä¸­â€¦');

      // MindAR é è¨­æœƒè‡ªè¡Œå‘¼å« getUserMediaï¼ˆæˆ‘å€‘å‰é¢å·²æˆæ¬Šï¼Œé€™è£¡é€šå¸¸ä¸å†å½ˆçª—ï¼‰
      // é¡å¤–ä¿éšªï¼šè‹¥ä¸€æ®µæ™‚é–“ä»æ²’ arReadyï¼Œå°±å•Ÿå‹•é™ç´š
      const fallbackTimer = setTimeout(async ()=>{
        if (!stageActive) return;
        setStatus('AR é€¾æ™‚ï¼Œåˆ‡æ›é™ç´šç›¸æ©Ÿæ¨¡å¼');
        await startFallbackCamera();
      }, 12000);

      // è‹¥æˆåŠŸ arReadyï¼Œæ¸…é™¤é€¾æ™‚è¨ˆæ™‚
      sceneEl.addEventListener('arReady', ()=>clearTimeout(fallbackTimer), {once:true});
    }

    async function startFallbackCamera(){
      $('#stage').classList.remove('active');
      $('#fallback').classList.add('active');
      stageActive = false;

      try{
        // ç›¡é‡ç”¨ä¹‹å‰é¸åˆ°çš„å¾Œé¡é ­
        const constraints = preGrantedDeviceId
          ? {video: {deviceId:{exact: preGrantedDeviceId}, width:{ideal:1280}, height:{ideal:720}}, audio:false}
          : {video: {facingMode:{ideal:'environment'}}, audio:false};
        activeFallbackStream = await navigator.mediaDevices.getUserMedia(constraints);
        $('#fallbackVideo').srcObject = activeFallbackStream;
      }catch(e){
        toast('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š' + (e?.message||e));
      }
    }

    function stopFallbackCamera(){
      try{
        if (activeFallbackStream){
          activeFallbackStream.getTracks().forEach(t=>t.stop());
          activeFallbackStream = null;
        }
      }catch(e){}
      $('#fallback').classList.remove('active');
    }

    function dataUrlDownload(dataUrl, filename){
      const a = document.createElement('a');
      a.href = dataUrl; a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>a.remove(), 0);
    }

    function openInNewTab(dataUrl){
      // iOS å¯èƒ½ä¸æ”¯æ´ downloadï¼Œé€€è€Œæ±‚å…¶æ¬¡
      const w = window.open();
      if (w){ w.document.title = 'Screenshot'; w.document.body.style.margin='0'; 
        const img = new Image(); img.src = dataUrl; img.style.width='100%'; img.style.height='auto';
        w.document.body.appendChild(img);
      }else{
        // æœ€å¾Œæ‰‹æ®µï¼šç›´æ¥æ›ç•¶å‰é 
        location.href = dataUrl;
      }
    }

    function getCaptureSize(){
      // å„ªå…ˆç”¨ç›¸æ©Ÿå½±ç‰‡è§£æåº¦ï¼Œå…¶æ¬¡ç”¨ canvasï¼Œå…¶æ¬¡è¦–çª—
      const v = getMindARCameraVideo() || $('#fallbackVideo');
      if (v && v.videoWidth && v.videoHeight){
        return {w: v.videoWidth, h: v.videoHeight, videoEl: v};
      }
      if (sceneCanvas){
        return {w: sceneCanvas.width, h: sceneCanvas.height, videoEl: getMindARCameraVideo()};
      }
      return {w: window.innerWidth, h: window.innerHeight, videoEl: getMindARCameraVideo()};
    }

    function captureComposite(arMode = true){
      // åˆæˆé †åºï¼šç›¸æ©Ÿ â†’ WebGLï¼ˆA-Frameï¼‰â†’ï¼ˆä½ ä¹Ÿå¯åœ¨æ­¤åŠ ä¸Š UI/æ°´å°ï¼‰
      const {w, h, videoEl} = getCaptureSize();
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');

      if (videoEl){
        try{ ctx.drawImage(videoEl, 0, 0, w, h); }catch(e){}
      }
      if (arMode && sceneCanvas){
        try{ ctx.drawImage(sceneCanvas, 0, 0, w, h); }catch(e){}
      }

      try{
        return canvas.toDataURL('image/png');
      }catch(e){
        console.warn('toDataURL å¤±æ•—ï¼Œå˜—è©¦å‚™æ´ï¼š', e);
        // å‚™æ´ï¼šåƒ…è¼¸å‡º WebGL ç•«é¢æˆ–åƒ…å½±ç‰‡ç•«é¢
        try{
          if (arMode && sceneCanvas) return sceneCanvas.toDataURL('image/png');
        }catch(e2){}
        try{
          if (videoEl){
            const canvas2 = document.createElement('canvas');
            canvas2.width = w; canvas2.height = h;
            canvas2.getContext('2d').drawImage(videoEl, 0, 0, w, h);
            return canvas2.toDataURL('image/png');
          }
        }catch(e3){}
        return null;
      }
    }

    function saveScreenshot(arMode = true){
      const url = captureComposite(arMode);
      if (!url){ toast('æˆªåœ–å¤±æ•—'); return; }
      try{
        dataUrlDownload(url, CONFIG.screenshotName);
        toast('å·²å„²å­˜');
      }catch(e){
        openInNewTab(url);
        toast('å·²æ–¼æ–°åˆ†é é–‹å•Ÿåœ–ç‰‡ï¼Œå¯é•·æŒ‰å„²å­˜');
      }
    }

    async function enterFlow(){
      // å…¥å£ç¸½æ§ï¼šå…©é‡ä¿éšª + æ¬Šé™è«‹æ±‚ï¼ˆä»¥ä½¿ç”¨è€…é»æ“Šç‚ºæ‰‹å‹¢ï¼‰
      if (!isSecureContextOk()){
        alert('éœ€è¦ HTTPSï¼ˆæˆ–åŒæ©Ÿ localhostï¼‰æ‰èƒ½å•Ÿç”¨ç›¸æ©Ÿã€‚è«‹éƒ¨ç½²åˆ° HTTPS æˆ–ä½¿ç”¨ ngrok/Netlify/GitHub Pagesã€‚');
        return;
      }
      setStatus('æª¢æŸ¥æ¬Šé™â€¦');
      try{
        await requestMotionPermissionIfNeeded(); // iOS å‹•ä½œ/æ–¹å‘ï¼ˆå¯é¸ï¼‰
        await requestWakeLock();                 // å¸¸äº®ï¼ˆå¯é¸ï¼‰
        await preflightCamera();                 // ç¬¬ä¸€å±¤ä¿éšªï¼šå…ˆæ‹¿åˆ°ç›¸æ©Ÿæˆæ¬Š
      }catch(e){
        alert((e && e.message) ? e.message : String(e));
        return;
      }
      await startAR();                           // æ­£å¼é€²å…¥ ARï¼ˆç¬¬äºŒå±¤ä¿éšªï¼šå•Ÿå‹•å¤±æ•—è‡ªå‹•é™ç´šï¼‰
      // å…¨è¢å¹•ï¼ˆå¯é¸ï¼‰
      try{
        const el = document.documentElement;
        if (el.requestFullscreen) el.requestFullscreen({navigationUI: 'hide'});
      }catch(e){}
    }

    function exitAll(){
      // çµ±ä¸€é€€å‡ºï¼šé—œé–‰ AR èˆ‡é™ç´šç›¸æ©Ÿã€é‡‹æ”¾è³‡æº
      try{
        const sceneEl = $('#arScene');
        const sys = sceneEl.systems && sceneEl.systems['mindar-image-system'];
        // å˜—è©¦åœæ­¢ MindAR
        if (sys && typeof sys.stop === 'function') sys.stop();
        // é¡å¤–å˜—è©¦ï¼ˆä¸åŒç‰ˆæœ¬å¯èƒ½æ›åœ¨ componentï¼‰
        if (sceneEl.components && sceneEl.components['mindar-image'] && typeof sceneEl.components['mindar-image'].stop === 'function'){
          sceneEl.components['mindar-image'].stop();
        }
      }catch(e){}
      stopFallbackCamera();
      if (wakeLock){ try{ wakeLock.release?.(); }catch(e){} wakeLock = null; }
      $('#stage').classList.remove('active');
      $('#fallback').classList.remove('active');
      $('#home').style.display = '';
      stageActive = false;
      setStatus('å°±ç·’');
      try{ document.exitFullscreen?.(); }catch(e){}
    }

    // ç¶å®š UI
    $('#enterBtn').addEventListener('click', enterFlow);
    $('#exitBtn').addEventListener('click', exitAll);
    $('#exitBtn2').addEventListener('click', exitAll);
    $('#saveBtn').addEventListener('click', ()=>saveScreenshot(true));
    $('#saveBtn2').addEventListener('click', ()=>saveScreenshot(false));
    $('#helpBtn').addEventListener('click', ()=>{
      alert([
        'ä½¿ç”¨æ–¹å¼ï¼š',
        '1) ç”¨å¦ä¸€å°è£ç½®æ‰“é–‹ç¤ºç¯„åœ–åƒï¼ˆcard.pngï¼‰',
        '2) é»ã€Œé€²å…¥ ARã€ï¼Œå…è¨±ç›¸æ©Ÿæ¬Šé™',
        '3) å°æº–åœ–åƒï¼Œæœƒå‡ºç¾è¦†å±¤åœ–ç‰‡èˆ‡å½±ç‰‡',
        '4) é»ã€Œå„²å­˜ã€å¯æŠŠç•«é¢å­˜æˆåœ–ç‰‡',
        '',
        'å°æç¤ºï¼šè‹¥ AR ç„¡æ³•å•Ÿå‹•ï¼Œç³»çµ±æœƒè‡ªå‹•åˆ‡åˆ°ã€Œé™ç´šç›¸æ©Ÿæ¨¡å¼ã€ï¼Œä»ç„¶å¯ä»¥æˆªåœ–ã€‚'
      ].join('\n'));
    });
    $('#howBtn').addEventListener('click', ()=>{
      alert([
        'éƒ¨ç½²æŒ‡å¼•ï¼ˆç°¡ç‰ˆï¼‰ï¼š',
        'â€¢ å‹™å¿…ä½¿ç”¨ HTTPS ç¶²å€ï¼ˆæˆ– localhostï¼‰ã€‚',
        'â€¢ æ¨è–¦å…è²»é¸é …ï¼šNetlify / GitHub Pages / Cloudflare Pagesã€‚',
        'â€¢ ç›´æ¥æŠŠé€™å€‹ index.html ä¸Šå‚³å³å¯ï¼ˆå–®æª”ç‰ˆï¼‰ã€‚',
        'â€¢ iOS Safari è‹¥è¦å…¨è¢å¹•æ²‰æµ¸é«”é©—ï¼Œå¯åŠ å…¥ä¸»ç•«é¢ï¼ˆPWA æ¨¡å¼æ•ˆæœæ›´ä½³ï¼‰ã€‚'
      ].join('\n'));
    });

    // é˜»æ­¢é›™æ“Šç¸®æ”¾
    document.addEventListener('touchend', (e)=>{
      const now = Date.now(); if (!window.__lastTouch) window.__lastTouch = 0;
      if (now - window.__lastTouch < 300) e.preventDefault();
      window.__lastTouch = now;
    }, {passive:false});
  </script>
</body>
</html>