<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARScan Pro - 專業AR圖像追蹤</title>
    <!-- Google Analytics Placeholder -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID'); // 替換為您的GA ID
    </script>
    <!-- A-Frame 核心庫 -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <!-- MindAR Image Tracking 庫 -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <!-- html2canvas 用於畫面捕捉 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* 商業級現代UI */
        @media (prefers-color-scheme: dark) { body { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); } }
        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100vh; color: white; overflow: hidden;
            transition: background 0.3s ease;
        }
        #logo { font-size: 1.5em; margin-bottom: 1em; }
        #intro { text-align: center; z-index: 100; }
        #intro h1 { font-size: 2em; margin-bottom: 1em; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        #status { font-size: 1em; margin-top: 10px; opacity: 0.8; }
        button {
            background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50px; color: white; font-size: 1.2em; padding: 15px 30px;
            cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px);
            touch-action: manipulation;
        }
        button:hover:not(:disabled) { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #ar-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        #save-btn, #share-btn { position: fixed; top: 20px; z-index: 50; right: 20px; }
        #share-btn { top: 80px; background: #4CAF50; }
        #error-msg, #permission-failed, #feed-error { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; display: none;
            text-align: center; z-index: 200; color: black; max-width: 80%; }
        #permission-failed button, #feed-error button { margin: 10px; background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; }
        #permission-failed button.cancel, #feed-error button.cancel { background: #f44336; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 100; flex-direction: column; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 480px) { #intro h1 { font-size: 1.5em; } button { font-size: 1em; padding: 12px 24px; } }
    </style>
</head>
<body>
    <!-- 品牌介紹 -->
    <div id="logo">ARScan Pro</div>
    <div id="intro">
        <h1>歡迎使用ARScan Pro</h1>
        <p>專業AR圖像追蹤：掃描指定圖像，解鎖互動體驗</p>
        <button id="start-ar">進入AR (Enter AR)</button>
        <div id="status"></div>
    </div>

    <!-- 權限失敗對話框 -->
    <div id="permission-failed">
        <h2>權限請求失敗</h2>
        <p>請點擊「允許」系統彈窗，或去設定 > Safari > 運動與方向 > 允許本網站。若仍卡住，重啟瀏覽器或切Chrome。</p>
        <button id="retry-permission">重試 (Retry)</button>
        <button class="cancel" onclick="cancelStart()">取消 (Cancel)</button>
    </div>

    <!-- Feed黑屏專屬錯誤 -->
    <div id="feed-error">
        <h2>鏡頭Feed未顯示</h2>
        <p>綠點亮但黑屏？請檢查Safari設定 > 進階 > 實驗性功能 > 啟用「Motion & Orientation Access」與「WebRTC」。或切Chrome重試。</p>
        <button id="retry-feed">重試Feed</button>
        <button class="cancel" onclick="retryStart()">返回開始</button>
    </div>

    <!-- 載入覆蓋層 -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>初始化AR中... (Initializing...)</p>
    </div>

    <!-- AR 容器 -->
    <div id="ar-container">
        <a-scene 
            id="ar-scene"
            mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind; autoStart: false; uiScanning: none;"
            color-space="sRGB" 
            renderer="colorManagement: true, physicallyCorrectLights" 
            vr-mode-ui="enabled: false" 
            embedded>
            
            <a-assets>
                <img id="card-img" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png" crossorigin="anonymous" />
                <a-asset-item id="avatar-model" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf" crossorigin="anonymous"></a-asset-item>
            </a-assets>

            <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

            <a-entity mindar-image-target="targetIndex: 0">
                <a-plane src="#card-img" position="0 0 0" height="0.552" width="1" rotation="0 0 0"></a-plane>
                <a-gltf-model 
                    rotation="0 0 0" 
                    position="0 0 0.1" 
                    scale="0.005 0.005 0.005" 
                    src="#avatar-model"
                    animation="property: position; to: 0 0.1 0.1; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate">
                </a-gltf-model>
            </a-entity>
        </a-scene>
        <button id="save-btn">儲存畫面 (Save)</button>
        <button id="share-btn">分享 (Share)</button>
    </div>

    <!-- 錯誤訊息 -->
    <div id="error-msg">
        <h2>發生錯誤 (Error)</h2>
        <p id="error-text">請檢查權限並重試 (Check permissions and retry)。</p>
        <button onclick="closeError()">關閉 (Close)</button>
    </div>

    <script>
        // 商業版全局變數
        let arSystem, cameraStream;
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
        console.log('Debug: Protocol = ' + location.protocol + ', Hostname = ' + location.hostname); // HTTPS debug

        // DOM元素
        const startBtn = document.getElementById('start-ar');
        const arContainer = document.getElementById('ar-container');
        const arScene = document.getElementById('ar-scene');
        const saveBtn = document.getElementById('save-btn');
        const shareBtn = document.getElementById('share-btn');
        const errorMsg = document.getElementById('error-msg');
        const errorText = document.getElementById('error-text');
        const status = document.getElementById('status');
        const loadingOverlay = document.getElementById('loading-overlay');
        const permissionFailed = document.getElementById('permission-failed');
        const feedError = document.getElementById('feed-error');
        const retryBtn = document.getElementById('retry-permission');
        const retryFeedBtn = document.getElementById('retry-feed');

        // 第一重：預請求相機（移除嚴格HTTPS拋錯，改warn）
        async function requestCameraStream() {
            if (!isHTTPS) {
                console.warn('非HTTPS環境，可能不穩定 - 建議GitHub Pages');
                gtag('event', 'non_https_warn');
            }
            try {
                status.textContent = '請求後置相機權限... (Requesting rear camera...)';
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                console.log('相機stream獲取成功');
                gtag('event', 'camera_granted');
                return cameraStream;
            } catch (err) {
                console.error('相機錯誤:', err);
                throw new Error('相機權限拒絕：' + err.message);
            }
        }

        // 手動iOS權限
        async function requestIOSPermissions() {
            if (!isIOS) return 'granted';
            status.textContent = '請求運動與方向權限... (系統彈窗請點「允許」)';
            await new Promise(resolve => setTimeout(resolve, 100));

            let motionGranted = 'granted';
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                motionGranted = await DeviceMotionEvent.requestPermission();
            }
            let orientationGranted = 'granted';
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                orientationGranted = await DeviceOrientationEvent.requestPermission();
            }

            if (motionGranted === 'granted' && orientationGranted === 'granted') {
                status.textContent = '權限OK，啟動鏡頭...';
                gtag('event', 'orientation_granted');
                return 'granted';
            } else {
                throw new Error('運動/方向權限拒絕');
            }
        }

        // 啟動AR（修復：'loadeddata'監聽 + 重試）
        async function startAR() {
            try {
                const stream = await requestCameraStream();
                await requestIOSPermissions();

                arContainer.style.display = 'block';
                document.getElementById('intro').style.display = 'none';
                setTimeout(() => loadingOverlay.style.display = 'flex', 200);

                arScene.addEventListener('loaded', () => {
                    arSystem = arScene.systems['mindar-image-system'];

                    // 修復：注入 + 監聽video loadeddata（確認feed顯示）
                    const injectVideo = () => {
                        if (arSystem && arSystem.video) {
                            arSystem.video.srcObject = stream;
                            arSystem.video.muted = true;
                            arSystem.video.playsInline = true;
                            arSystem.video.play().catch(console.error);
                            console.log('Stream注入video成功');

                            // 新增：監聽loadeddata，隱藏loading
                            arSystem.video.addEventListener('loadeddata', () => {
                                console.log('Video feed載入完成');
                                loadingOverlay.style.display = 'none';
                                status.textContent = 'AR啟動，掃描圖像... (Scan image to activate)';
                                gtag('event', 'feed_displayed');
                                clearTimeout(startTimeout);
                            }, { once: true });

                            gtag('event', 'feed_injected');
                        } else {
                            console.warn('arSystem.video未找到，延遲重試');
                            setTimeout(injectVideo, 500);
                        }
                    };
                    injectVideo();

                    // 事件監聽
                    arScene.addEventListener('arError', (e) => {
                        console.error('AR錯誤:', e.detail);
                        loadingOverlay.style.display = 'none';
                        errorText.textContent = 'AR失敗：' + (e.detail || '重試') + '。';
                        errorMsg.style.display = 'block';
                        gtag('event', 'ar_error');
                        cleanupStream();
                    });

                    arScene.addEventListener('camera-error', (e) => {
                        console.error('Camera錯誤:', e.detail);
                        feedError.style.display = 'block';
                        gtag('event', 'feed_failed');
                    });

                    arScene.addEventListener('arReady', () => {
                        console.log('AR就緒！');
                        if (loadingOverlay.style.display !== 'none') loadingOverlay.style.display = 'none';
                        status.textContent = 'AR啟動，掃描圖像...';
                        gtag('event', 'ar_ready');
                    });

                    // 超時：若無loadeddata，顯示feed錯誤
                    startTimeout = setTimeout(() => {
                        if (loadingOverlay.style.display !== 'none') {
                            console.warn('Feed超時，顯示錯誤提示');
                            loadingOverlay.style.display = 'none';
                            feedError.style.display = 'block';
                            gtag('event', 'feed_timeout');
                            arSystem?.stop();
                        }
                    }, 3000);

                    arSystem.start();
                });

                window.addEventListener('beforeunload', cleanupStream);
            } catch (err) {
                console.error('啟動錯誤:', err);
                loadingOverlay.style.display = 'none';
                errorText.textContent = err.message + '。請檢查權限。';
                errorMsg.style.display = 'block';
                gtag('event', 'start_error', { error: err.message });
                cleanupStream();
            }
        }

        function cleanupStream() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
                cameraStream = null;
            }
        }

        // 事件：進入AR
        startBtn.addEventListener('click', (e) => {
            e.preventDefault(); e.stopPropagation();
            startBtn.disabled = true;
            startBtn.textContent = '啟動中... (Starting...)';
            startAR();
        });

        // 重試權限
        retryBtn.addEventListener('click', () => {
            permissionFailed.style.display = 'none';
            cleanupStream();
            startAR();
        });

        // 重試Feed
        retryFeedBtn.addEventListener('click', () => {
            feedError.style.display = 'none';
            loadingOverlay.style.display = 'flex';
            if (arSystem) arSystem.stop();
            cleanupStream();
            startAR();
        });

        // 儲存畫面
        saveBtn.addEventListener('click', () => {
            html2canvas(arScene.canvas, { scale: 1, useCORS: true, backgroundColor: null })
                .then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'ARScan-Pro.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    gtag('event', 'save_screenshot');
                }).catch(err => {
                    console.error('儲存錯誤:', err);
                    alert('儲存失敗，重試。');
                });
        });

        // 分享
        shareBtn.addEventListener('click', async () => {
            if (navigator.share) {
                await navigator.share({ title: 'ARScan Pro', url: location.href });
                gtag('event', 'share');
            } else {
                alert('分享連結：' + location.href);
            }
        });

        // 輔助
        function closeError() { errorMsg.style.display = 'none'; startBtn.disabled = false; startBtn.textContent = '進入AR (Enter AR)'; status.textContent = ''; }
        function cancelStart() { permissionFailed.style.display = 'none'; startBtn.disabled = false; startBtn.textContent = '進入AR (Enter AR)'; status.textContent = ''; cleanupStream(); }
        function retryStart() { feedError.style.display = 'none'; startBtn.disabled = false; startBtn.textContent = '進入AR (Enter AR)'; status.textContent = ''; document.getElementById('intro').style.display = 'block'; arContainer.style.display = 'none'; cleanupStream(); }
    </script>
</body>
</html>