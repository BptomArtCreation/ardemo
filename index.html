<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MindAR Image - æ‰‹æ©Ÿ AR ç¯„ä¾‹</title>
  
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    :root {
      --brand: #4f46e5;
      --brand-2: #8b5cf6;
      --ok: #16a34a;
      --warn: #ca8a04;
      --danger: #ef4444;
      --bg: #0b1020;
      --card: rgba(255,255,255,0.08);
      --glass: rgba(15,18,36,0.48);
      --text: #e5e7eb;
      --muted: #94a3b8;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 600px at 20% -10%, #1e293b 0%, #0b1020 60%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Apple Color Emoji, Segoe UI Emoji, "PingFang TC", "Microsoft JhengHei", sans-serif;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      overflow: hidden;
    }
    /* é ‚éƒ¨æ§åˆ¶åˆ— */
    .topbar {
      position: fixed; top: 0; left: 0; right: 0; height: 64px;
      display: flex; align-items: center; justify-content: space-between;
      padding: env(safe-area-inset-top) 16px 0 16px;
      backdrop-filter: blur(8px);
      background: linear-gradient(to bottom, rgba(0,0,0,0.35), rgba(0,0,0,0));
      z-index: 10;
      pointer-events: none;
    }
    .topbar .title {
      pointer-events: auto;
      display: flex; align-items: center; gap: 10px; padding: 8px 12px;
      border-radius: 12px;
      background: var(--glass); border: 1px solid rgba(255,255,255,0.06);
      font-weight: 600;
    }
    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 999px;
      background: rgba(79,70,229,0.15);
      border: 1px solid rgba(79,70,229,0.35); color: #c7d2fe; font-weight: 600; font-size: 12px;
    }
    .right-controls {
      pointer-events: auto;
      display: flex; gap: 8px; align-items: center;
    }
    .btn {
      appearance: none; border: 0; outline: 0;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: #fff; font-weight: 700; letter-spacing: 0.2px;
      padding: 12px 16px; border-radius: 12px; cursor: pointer;
      box-shadow: 0 10px 24px rgba(99,102,241,0.25), inset 0 -2px 0 rgba(0,0,0,0.2);
      transition: transform 0.06s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      font-size: 14px; /* ç¢ºä¿æ‰‹æ©ŸæŒ‰éˆ•æ–‡å­—å¯è®€ */
      min-width: 88px; /* æœ€å°è§¸æ§å€åŸŸ */
      touch-action: manipulation;
    }
    .btn:active { transform: translateY(1px); }
    .btn.secondary {
      background: rgba(255,255,255,0.12); color: #fff; font-weight: 600;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
    }
    .btn.ghost {
      background: transparent; color: var(--text); font-weight: 600;
      border: 1px solid rgba(255,255,255,0.22);
      backdrop-filter: blur(6px);
    }
    .btn.ok { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .btn.warn { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .btn.danger { background: linear-gradient(135deg, #ef4444, #dc2626); }

    /* é¦–å±å¼•å° */
    .hero {
      position: fixed; inset: 0; display: grid; place-items: center; z-index: 9;
      padding: 24px; background: radial-gradient(900px 600px at 70% -20%, #1e293b 0%, #0b1020 60%);
    }
    .card {
      width: min(520px, 92vw);
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 20px; padding: 22px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.05);
      backdrop-filter: blur(8px);
      text-align: center;
    }
    .card h1 { margin: 6px 0 8px; font-size: clamp(18px, 5vw, 22px); } /* è‡ªé©æ‡‰å­—é«” */
    .card p  { margin: 6px 0 16px; color: var(--muted); line-height: 1.5; font-size: clamp(14px, 4vw, 16px); }
    .row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }

    /* ä¸‹æ–¹å·¥å…·åˆ—ï¼ˆAR å•Ÿå‹•å¾Œé¡¯ç¤ºï¼‰ */
    .bottombar {
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 8px 12px calc(10px + env(safe-area-inset-bottom));
      display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; /* å…è¨±æ›è¡Œä»¥é©æ‡‰å°å± */
      background: linear-gradient(to top, rgba(0,0,0,0.35), rgba(0,0,0,0));
      z-index: 10;
      pointer-events: none;
    }
    .bottombar .btn { pointer-events: auto; flex: 1; max-width: 120px; } /* è‡ªé©æ‡‰æŒ‰éˆ•å¯¬åº¦ */
    .tip {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: calc(64px + env(safe-area-inset-bottom));
      padding: 8px 12px; border-radius: 12px; background: var(--glass);
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--muted); font-size: clamp(12px, 3vw, 14px); z-index: 10; /* è‡ªé©æ‡‰æç¤ºæ–‡å­— */
      max-width: 90vw; text-align: center;
    }
    /* æç¤º/éŒ¯èª¤ toast */
    .toast {
      position: fixed; left: 50%; transform: translateX(-50%);
      top: calc(80px + env(safe-area-inset-top));
      padding: 10px 14px; border-radius: 10px; background: var(--glass);
      border: 1px solid rgba(255,255,255,0.10);
      color: #fff; font-size: 14px; z-index: 15; display: none;
      backdrop-filter: blur(8px);
      max-width: 90vw; /* é˜²æ­¢ toast æº¢å‡ºå°å± */
    }
    .toast.show { display: inline-flex; align-items: center; gap: 8px; }
    .toast.ok { border-color: rgba(34,197,94,0.35); }
    .toast.warn { border-color: rgba(245,158,11,0.35); }
    .toast.err { border-color: rgba(239,68,68,0.35); }

    /* AR å ´æ™¯é‹ªæ»¿ï¼ˆembedded æ¨¡å¼ï¼‰*/
    #ar-container {
      position: fixed; inset: 0; width: 100vw; height: 100vh; overflow: hidden; z-index: 1;
    }
    a-scene {
      position: absolute !important;
      inset: 0 !important;
      width: 100% !important;
      height: 100% !important;
      touch-action: none;
    }

    /* è¼”åŠ©é¢æ¿ï¼ˆå¯é—œé–‰ï¼‰ */
    .helper {
      position: fixed; right: 10px; bottom: calc(70px + env(safe-area-inset-bottom));
      z-index: 11; max-width: min(420px, 92vw);
      background: rgba(30,41,59,0.8);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px; padding: 12px;
      color: #e2e8f0; font-size: 13px; line-height: 1.4;
      display: none;
    }
    .helper.show { display: block; }
    .helper code { background: rgba(148,163,184,0.15); padding: 1px 6px; border-radius: 6px; }
    .link { color: #93c5fd; text-decoration: underline; }

    /* é¡å¤–è‡ªé©æ‡‰ï¼šå°å±èª¿æ•´é–“è· */
    @media (max-width: 480px) {
      .topbar { padding: env(safe-area-inset-top) 8px 0 8px; height: 56px; }
      .bottombar { padding: 4px 8px calc(8px + env(safe-area-inset-bottom)); gap: 4px; }
      .card { padding: 16px; }
      .row { gap: 4px; }
      .btn { padding: 10px 12px; font-size: 13px; }
    }
  </style>
</head>
<body>
  <!-- é ‚éƒ¨æ§åˆ¶åˆ— -->
  <div class="topbar">
    <div class="title">
      MindAR â€¢ Image<br>æ‰‹æ©Ÿ AR ç¯„ä¾‹
    </div>
    <div class="right-controls">
      <button id="btnHelp" class="btn ghost">ä½¿ç”¨èªªæ˜</button>
      <button id="btnEnter" class="btn">é€²å…¥ AR</button>
    </div>
  </div>

  <!-- é¦–å±å¼•å° -->
  <div id="hero" class="hero">
    <div class="card">
      <h1>ğŸ“±âœ¨</h1>
      <p>é–‹å§‹ä½ çš„åœ–ç‰‡è¿½è¹¤ AR</p>
      <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•æˆæ¬Šä½¿ç”¨å¾Œç½®ç›¸æ©Ÿã€‚å°æº–ç›®æ¨™åœ–å¡å¾Œï¼Œå°‡é¡¯ç¤ºé è¨­åœ–ç‰‡æˆ–å½±ç‰‡ï¼ˆå·²é ç•™ 3D æ¨¡å‹ä½ç½®ï¼‰ã€‚</p>
      <div class="row">
        <button id="btnEnterHero" class="btn">é€²å…¥ AR</button>
        <a href="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card1.jpg" target="_blank" class="btn secondary">ä¸‹è¼‰ç›®æ¨™åœ–</a>
      </div>
      <p>è‹¥é‡é»‘ç•«é¢ï¼šè«‹ä½¿ç”¨ HTTPS ç¶²å€ã€å…è¨±ç›¸æ©Ÿæ¬Šé™ã€æ›´æ–° Safari/Chrome è‡³æœ€æ–°ç‰ˆã€‚</p>
    </div>
  </div>

  <!-- Toast æç¤º -->
  <div id="toast" class="toast"></div>

  <!-- AR å®¹å™¨ -->
  <div id="ar-container">
    <a-scene id="ar-scene" mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/targets.mind; autoStart: false; uiScanning: true; uiLoading: true; uiError: true; maxTrack: 1" color-space="sRGB" renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true; antialias: true; precision: mediump; preserveDrawingBuffer: true" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" embedded="">
      <a-assets timeout="120000">
        <!-- å…§åµŒ SVG åœ–ç‰‡ï¼ˆé¿å…è·¨åŸŸï¼Œæ–¹ä¾¿æˆªåœ–ï¼‰ -->
        <img id="overlayImg" crossorigin="anonymous" src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1024' height='1024'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0' stop-color='%23a78bfa'/%3E%3Cstop offset='1' stop-color='%234f46e5'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100%25' height='100%25' rx='64' fill='url(%23g)'/%3E%3Cg fill='%23fff' font-family='Arial, Helvetica, sans-serif' text-anchor='middle'%3E%3Ctext x='512' y='520' font-size='80' font-weight='700'%3EMindAR Overlay%3C/text%3E%3Ctext x='512' y='600' font-size='40' opacity='0.85'%3EæƒææˆåŠŸï¼%3C/text%3E%3C/g%3E%3C/svg%3E">
        <!-- ç¯„ä¾‹å½±ç‰‡ï¼ˆè‹¥è¦ä¿è­‰å¯æˆªåœ–ï¼Œå»ºè­°å°‡å½±ç‰‡æ”¾åœ¨åŒç¶²åŸŸï¼‰ -->
        <video id="overlayVideo" playsinline webkit-playsinline muted loop preload="auto" crossorigin="anonymous"
          src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/face-animation.mp4"></video>
        <!-- é ç•™ 3D æ¨¡å‹ï¼ˆä¹‹å¾Œå¯è‡ªè¡Œæ›æˆä½ çš„ .glb/.gltfï¼‰ -->
        <!-- <a-asset-item id="modelGLB" src="./models/your-model.glb"></a-asset-item> -->
      </a-assets>
      <!-- å¿…é ˆæœ‰ä¸€å€‹æ”å½±æ©Ÿ -->
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      <!-- ç›®æ¨™1ï¼ˆå°æ‡‰ targets.mind çš„ index: 0ï¼‰-->
      <a-entity id="target-0" mindar-image-target="targetIndex: 0">
        <!-- åœ–ç‰‡è¦†è“‹ -->
        <a-plane id="img-plane" src="#overlayImg" position="0 0 0" rotation="0 0 0" width="1" height="0.56" visible="true" material="transparent: true; side: double"></a-plane>
        <!-- å½±ç‰‡è¦†è“‹ï¼ˆé è¨­è—èµ·ï¼Œç­‰æ‰¾åˆ°ç›®æ¨™å†é¡¯ç¤ºï¼‰ -->
        <a-plane id="video-plane" position="0 -0.05 0" rotation="0 0 0" width="1" height="0.56" visible="false"
          material="src: #overlayVideo; transparent: true; side: double"></a-plane>
        <!-- é ç•™ 3D æ¨¡å‹ -->
        <!--
        <a-entity id="model-entity"
                  gltf-model="#modelGLB"
                  position="0 0.1 0" rotation="0 0 0" scale="0.2 0.2 0.2"
                  visible="false"></a-entity>
        -->
      </a-entity>
    </a-scene>
  </div>

  <!-- ä¸‹æ–¹å·¥å…·åˆ—ï¼ˆAR å•Ÿå‹•å¾Œé¡¯ç¤ºï¼‰ -->
  <div id="bottombar" class="bottombar">
    <button id="btnSave" class="btn ok">å„²å­˜æˆªåœ–</button>
    <button id="btnToggleVideo" class="btn secondary">åˆ‡æ›é¡¯ç¤ºï¼šå½±ç‰‡/åœ–ç‰‡</button>
    <button id="btnStop" class="btn danger">é›¢é–‹ AR</button>
  </div>

  <!-- æç¤ºæ–‡å­— -->
  <div id="tip" class="tip">å°æº–ä¸Šæ–¹ã€Œä¸‹è¼‰ç›®æ¨™åœ–ã€çš„å¡ç‰‡è©¦è©¦çœ‹ ğŸ‘€</div>

  <!-- è¼”åŠ©é¢æ¿ -->
  <div id="helper" class="helper">
    <h3>ä½¿ç”¨èªªæ˜ / é™¤éŒ¯</h3>
    <ul>
      <li>è«‹ä½¿ç”¨ <a href="https://https.cio.gov/" target="_blank" class="link">HTTPS</a> ç¶²å€ï¼ˆæˆ–æœ¬æ©Ÿ HTTPS ä¼ºæœå™¨ï¼‰ï¼Œå¦å‰‡ç›¸æ©Ÿå¯èƒ½ç„¡æ³•å•Ÿå‹•ã€‚</li>
      <li>é¦–æ¬¡é€²å…¥è«‹ã€Œå…è¨±ç›¸æ©Ÿæ¬Šé™ã€ã€‚è‹¥ä¸å°å¿ƒæ‹’çµ•ï¼Œè«‹åˆ°ç€è¦½å™¨è¨­å®šé‡è¨­æ¬Šé™ã€‚</li>
      <li>å½±ç‰‡åœ¨ iOS éœ€éœéŸ³æ‰èƒ½è‡ªå‹•æ’­æ”¾ï¼Œå·²å¼·åˆ¶ <code>mute</code> + <code>playsinline</code>ã€‚</li>
      <li>è‹¥æˆªåœ–å¤±æ•—ï¼šè«‹å°‡å½±ç‰‡å’Œåœ–ç‰‡ç´ ææ”¾åœ¨åŒç¶²åŸŸï¼ˆé¿å… CORS æ±™æŸ“ï¼‰ã€‚</li>
      <li>æ¸¬è©¦ç›®æ¨™åœ–ï¼š<a href="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card1.jpg" target="_blank" class="link">é»æ­¤é–‹å•Ÿ</a></li>
    </ul>
    <button id="btnCloseHelp" class="btn ghost">é—œé–‰</button>
  </div>

  <script>
    // å°å·¥å…·ï¼šToast æç¤º
    const toastEl = document.getElementById('toast');
    function toast(msg, type='ok', timeout=2200) {
      toastEl.textContent = msg;
      toastEl.className = `toast show ${type}`;
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=> toastEl.className = 'toast', timeout);
    }

    // å…ƒç´ 
    const sceneEl   = document.getElementById('ar-scene');
    const heroEl    = document.getElementById('hero');
    const tipEl     = document.getElementById('tip');
    const bottomEl  = document.getElementById('bottombar');
    const btnEnter  = document.getElementById('btnEnter');
    const btnEnterHero = document.getElementById('btnEnterHero');
    const btnSave   = document.getElementById('btnSave');
    const btnStop   = document.getElementById('btnStop');
    const btnToggleVideo = document.getElementById('btnToggleVideo');
    const btnHelp   = document.getElementById('btnHelp');
    const helperEl  = document.getElementById('helper');
    const btnCloseHelp = document.getElementById('btnCloseHelp');

    const target0El = document.getElementById('target-0');
    const videoEl   = document.getElementById('overlayVideo');
    const videoPlane= document.getElementById('video-plane');
    const imgPlane  = document.getElementById('img-plane');

    // ç‹€æ…‹
    let arRunning = false;
    let showVideo = false;

    // é»‘ç•«é¢é é˜² 1ï¼šé–‹å•Ÿå‰æª¢æŸ¥ HTTPS èˆ‡ API æ”¯æ´
    function preflightCheck() {
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        toast('å»ºè­°ä½¿ç”¨ HTTPSï¼Œå¦å‰‡ç›¸æ©Ÿå¯èƒ½ç„¡æ³•å•Ÿå‹•', 'warn', 3000);
      }
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        toast('æ­¤è¨­å‚™/ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿ', 'err', 4000);
        throw new Error('mediaDevices.getUserMedia not supported');
      }
      const gl2 = document.createElement('canvas').getContext('webgl2');
      if (!gl2) {
        toast('æ­¤è¨­å‚™ä¸æ”¯æ´ WebGL2ï¼ŒMindAR å¯èƒ½ç„¡æ³•å•Ÿå‹•', 'warn', 4000);
      }
    }

    // å•Ÿå‹• AR
    async function startAR() {
      if (arRunning) return;
      preflightCheck();

      const arSystem = sceneEl.systems['mindar-image-system'];
      try {
        // iOS å½±ç‰‡è‡ªå‹•æ’­æ”¾éœ€åœ¨æ‰‹å‹¢ä¸­é å…ˆ playï¼ˆmutedï¼‰
        try { await videoEl.play(); } catch(e) { /* å¿½ç•¥ */ }

        await arSystem.start(); // MindAR å•Ÿå‹•
        heroEl.style.display = 'none'; // æˆæ¬ŠæˆåŠŸå¾Œç«‹å³éš±è—é¦–å±ï¼Œé€²å…¥ AR è¦–åœ–
        await readyPromise; // ç­‰å¾… arReady
        arRunning = true;

        // é¡¯ç¤ºæ§åˆ¶åˆ—
        bottomEl.style.display = 'flex';
        tipEl.style.display = 'block';
        toast('AR å·²å•Ÿå‹•', 'ok');

        // é˜²æ­¢ Safari æŠŠç›¸æ©Ÿç•¶æˆå…¨è¢å¹•å½±ç‰‡
        if (arSystem.video) {
          arSystem.video.setAttribute('playsinline', 'true');
          arSystem.video.setAttribute('webkit-playsinline', 'true');
        }
      } catch (err) {
        console.error(err);
        heroEl.style.display = 'grid'; // éŒ¯èª¤æ™‚æ¢å¾©é¦–å±
        toast('AR å•Ÿå‹•å¤±æ•—ï¼š' + (err.message || err.toString()), 'err', 4000);
      }
    }

    // åœæ­¢ AR
    async function stopAR() {
      if (!arRunning) return;
      const arSystem = sceneEl.systems['mindar-image-system'];
      await arSystem.stop();
      arRunning = false;
      bottomEl.style.display = 'none';
      tipEl.style.display = 'none';
      heroEl.style.display = 'grid';
      // åœæ­¢å½±ç‰‡æ’­æ”¾
      try { videoEl.pause(); } catch(e) {}
      toast('AR å·²é—œé–‰', 'ok');
    }

    // æˆªåœ–ï¼ˆåŒ…å«ç›¸æ©ŸèƒŒæ™¯èˆ‡ 3D ç‰©ä»¶ï¼‰
    async function saveSnapshot() {
      const renderer = sceneEl.renderer;
      if (!renderer || !renderer.domElement) {
        toast('æˆªåœ–å¤±æ•—ï¼šRenderer æœªå°±ç·’', 'err'); return;
      }

      // è‹¥é¡¯ç¤ºäº†è·¨åŸŸå½±ç‰‡æè³ªï¼ŒCanvas æœƒè¢«æ±™æŸ“ï¼Œé€™è£¡å…ˆæš«æ™‚éš±è—å½±ç‰‡ 1~2 frame ä»¥é¿é–‹
      const wasVideoVisible = videoPlane.getAttribute('visible') === true || videoPlane.getAttribute('visible') === 'true';
      if (wasVideoVisible) {
        videoPlane.setAttribute('visible', false);
        // ç­‰å¾…å…©å€‹ animation frameï¼Œç¢ºä¿ç•«é¢å·²æ›´æ–°
        await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
      }

      try {
        const dataURL = renderer.domElement.toDataURL('image/png'); // éœ€è¦ preserveDrawingBuffer: true
        // æ¨ä¸‹è¼‰ï¼ˆiOS æœ‰æ™‚ä¸æ”¯æ´ download å±¬æ€§ï¼Œå‚™æ´é–‹æ–°çª—ï¼‰
        const a = document.createElement('a');
        a.href = dataURL; a.download = 'ar-snapshot.png';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);

        // è‹¥ç€è¦½å™¨é˜»æ“‹ downloadï¼Œå°±é–‹æ–°è¦–çª—é è¦½
        setTimeout(() => {
          if (!document.hasFocus()) window.open(dataURL, '_blank');
        }, 300);
        toast('å·²å„²å­˜æˆªåœ–ï¼ˆè‹¥æœªè‡ªå‹•ä¸‹è¼‰ï¼Œè«‹æ‰‹å‹•é•·æŒ‰å¦å­˜ï¼‰', 'ok', 2600);
      } catch (err) {
        console.error(err);
        toast('æˆªåœ–å¤±æ•—ï¼šå¯èƒ½ç‚ºè·¨ç¶²åŸŸç´ æå°è‡´ã€‚è«‹æŠŠå½±ç‰‡/åœ–ç‰‡æ”¾åŒç¶²åŸŸã€‚', 'warn', 3600);
      } finally {
        if (wasVideoVisible) {
          videoPlane.setAttribute('visible', true);
        }
      }
    }

    // åˆ‡æ›é¡¯ç¤ºåœ–ç‰‡/å½±ç‰‡
    function toggleVideoOrImage() {
      showVideo = !showVideo;
      videoPlane.setAttribute('visible', showVideo);
      imgPlane.setAttribute('visible', !showVideo);
      if (showVideo) {
        try { videoEl.play(); } catch(e) {}
        btnToggleVideo.textContent = 'åˆ‡æ›é¡¯ç¤ºï¼šåœ–ç‰‡';
      } else {
        try { videoEl.pause(); } catch(e) {}
        btnToggleVideo.textContent = 'åˆ‡æ›é¡¯ç¤ºï¼šå½±ç‰‡';
      }
    }

    // ç¶å®šäº‹ä»¶
    btnEnter.addEventListener('click', startAR);
    btnEnterHero.addEventListener('click', startAR);
    btnStop.addEventListener('click', stopAR);
    btnSave.addEventListener('click', saveSnapshot);
    btnToggleVideo.addEventListener('click', toggleVideoOrImage);

    // èªªæ˜é¢æ¿
    btnHelp.addEventListener('click', ()=> helperEl.classList.add('show'));
    btnCloseHelp.addEventListener('click', ()=> helperEl.classList.remove('show'));

    // ç›®æ¨™åµæ¸¬äº‹ä»¶ï¼šæ‰¾åˆ°/å¤±å»ç›®æ¨™
    target0El.addEventListener('targetFound', () => {
      // é è¨­é¡¯ç¤ºåœ–ç‰‡ï¼Œå¯æŒ‰æŒ‰éˆ•åˆ‡æ›å½±ç‰‡
      if (showVideo) {
        videoPlane.setAttribute('visible', true);
        try { videoEl.play(); } catch(e) {}
      }
      imgPlane.setAttribute('visible', !showVideo);
    });
    target0El.addEventListener('targetLost', () => {
      // ä¿å®ˆä½œæ³•ï¼šæ‰¾åˆ°ç›®æ¨™æ‰é¡¯ç¤ºï¼Œä¸Ÿå¤±å°±æš«åœå½±ç‰‡
      try { videoEl.pause(); } catch(e) {}
    });

    // MindAR å…¨åŸŸäº‹ä»¶
    let resolveReady;
    const readyPromise = new Promise(r => resolveReady = r);
    sceneEl.addEventListener('arReady', () => {
      console.log('MindAR ready');
      resolveReady();
    });
    sceneEl.addEventListener('arError', (e) => {
      console.error('MindAR error', e);
      heroEl.style.display = 'grid'; // éŒ¯èª¤æ™‚æ¢å¾©é¦–å±
      toast('AR å•Ÿå‹•éŒ¯èª¤ï¼šè«‹ç¢ºèªç›¸æ©Ÿæ¬Šé™èˆ‡ HTTPS', 'err', 3600);
    });
  </script>
</body>
</html>