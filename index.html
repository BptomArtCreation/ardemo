<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MindAR Image - 手機 AR 範例</title>
  
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.6.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    :root {
      --brand: #4f46e5;
      --brand-2: #8b5cf6;
      --ok: #16a34a;
      --warn: #ca8a04;
      --danger: #ef4444;
      --bg: #0b1020;
      --card: rgba(255,255,255,0.08);
      --glass: rgba(15,18,36,0.48);
      --text: #e5e7eb;
      --muted: #94a3b8;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 600px at 20% -10%, #1e293b 0%, #0b1020 60%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Apple Color Emoji, Segoe UI Emoji, "PingFang TC", "Microsoft JhengHei", sans-serif;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      overflow: hidden;
    }
    /* 頂部控制列 */
    .topbar {
      position: fixed; top: 0; left: 0; right: 0; height: 64px;
      display: flex; align-items: center; justify-content: space-between;
      padding: env(safe-area-inset-top) 16px 0 16px;
      backdrop-filter: blur(8px);
      background: linear-gradient(to bottom, rgba(0,0,0,0.35), rgba(0,0,0,0));
      z-index: 10;
      pointer-events: none;
    }
    .topbar .title {
      pointer-events: auto;
      display: flex; align-items: center; gap: 10px; padding: 8px 12px;
      border-radius: 12px;
      background: var(--glass); border: 1px solid rgba(255,255,255,0.06);
      font-weight: 600;
    }
    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 999px;
      background: rgba(79,70,229,0.15);
      border: 1px solid rgba(79,70,229,0.35); color: #c7d2fe; font-weight: 600; font-size: 12px;
    }
    .right-controls {
      pointer-events: auto;
      display: flex; gap: 8px; align-items: center;
    }
    .btn {
      appearance: none; border: 0; outline: 0;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: #fff; font-weight: 700; letter-spacing: 0.2px;
      padding: 12px 16px; border-radius: 12px; cursor: pointer;
      box-shadow: 0 10px 24px rgba(99,102,241,0.25), inset 0 -2px 0 rgba(0,0,0,0.2);
      transition: transform 0.06s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      font-size: 14px; /* 確保手機按鈕文字可讀 */
      min-width: 88px; /* 最小觸控區域 */
      touch-action: manipulation;
    }
    .btn:active { transform: translateY(1px); }
    .btn.secondary {
      background: rgba(255,255,255,0.12); color: #fff; font-weight: 600;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
    }
    .btn.ghost {
      background: transparent; color: var(--text); font-weight: 600;
      border: 1px solid rgba(255,255,255,0.22);
      backdrop-filter: blur(6px);
    }
    .btn.ok { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .btn.warn { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .btn.danger { background: linear-gradient(135deg, #ef4444, #dc2626); }

    /* 首屏引導 */
    .hero {
      position: fixed; inset: 0; display: grid; place-items: center; z-index: 9;
      padding: 24px; background: radial-gradient(900px 600px at 70% -20%, #1e293b 0%, #0b1020 60%);
    }
    .card {
      width: min(520px, 92vw);
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 20px; padding: 22px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.05);
      backdrop-filter: blur(8px);
      text-align: center;
    }
    .card h1 { margin: 6px 0 8px; font-size: clamp(18px, 5vw, 22px); } /* 自適應字體 */
    .card p  { margin: 6px 0 16px; color: var(--muted); line-height: 1.5; font-size: clamp(14px, 4vw, 16px); }
    .row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }

    /* 下方工具列（AR 啟動後顯示） */
    .bottombar {
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 8px 12px calc(10px + env(safe-area-inset-bottom));
      display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; /* 允許換行以適應小屏 */
      background: linear-gradient(to top, rgba(0,0,0,0.35), rgba(0,0,0,0));
      z-index: 10;
      pointer-events: none;
    }
    .bottombar .btn { pointer-events: auto; flex: 1; max-width: 120px; } /* 自適應按鈕寬度 */
    .tip {
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: calc(64px + env(safe-area-inset-bottom));
      padding: 8px 12px; border-radius: 12px; background: var(--glass);
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--muted); font-size: clamp(12px, 3vw, 14px); z-index: 10; /* 自適應提示文字 */
      max-width: 90vw; text-align: center;
    }
    /* 提示/錯誤 toast */
    .toast {
      position: fixed; left: 50%; transform: translateX(-50%);
      top: calc(80px + env(safe-area-inset-top));
      padding: 10px 14px; border-radius: 10px; background: var(--glass);
      border: 1px solid rgba(255,255,255,0.10);
      color: #fff; font-size: 14px; z-index: 15; display: none;
      backdrop-filter: blur(8px);
      max-width: 90vw; /* 防止 toast 溢出小屏 */
    }
    .toast.show { display: inline-flex; align-items: center; gap: 8px; }
    .toast.ok { border-color: rgba(34,197,94,0.35); }
    .toast.warn { border-color: rgba(245,158,11,0.35); }
    .toast.err { border-color: rgba(239,68,68,0.35); }

    /* AR 場景鋪滿（embedded 模式）*/
    #ar-container {
      position: fixed; inset: 0; width: 100vw; height: 100vh; overflow: hidden; z-index: 1;
    }
    a-scene {
      position: absolute !important;
      inset: 0 !important;
      width: 100% !important;
      height: 100% !important;
      touch-action: none;
    }

    /* 輔助面板（可關閉） */
    .helper {
      position: fixed; right: 10px; bottom: calc(70px + env(safe-area-inset-bottom));
      z-index: 11; max-width: min(420px, 92vw);
      background: rgba(30,41,59,0.8);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px; padding: 12px;
      color: #e2e8f0; font-size: 13px; line-height: 1.4;
      display: none;
    }
    .helper.show { display: block; }
    .helper code { background: rgba(148,163,184,0.15); padding: 1px 6px; border-radius: 6px; }
    .link { color: #93c5fd; text-decoration: underline; }

    /* 額外自適應：小屏調整間距 */
    @media (max-width: 480px) {
      .topbar { padding: env(safe-area-inset-top) 8px 0 8px; height: 56px; }
      .bottombar { padding: 4px 8px calc(8px + env(safe-area-inset-bottom)); gap: 4px; }
      .card { padding: 16px; }
      .row { gap: 4px; }
      .btn { padding: 10px 12px; font-size: 13px; }
    }
  </style>
</head>
<body>
  <!-- 頂部控制列 -->
  <div class="topbar">
    <div class="title">
      MindAR • Image<br>手機 AR 範例
    </div>
    <div class="right-controls">
      <button id="btnHelp" class="btn ghost">使用說明</button>
      <button id="btnEnter" class="btn">進入 AR</button>
    </div>
  </div>

  <!-- 首屏引導 -->
  <div id="hero" class="hero">
    <div class="card">
      <h1>📱✨</h1>
      <p>開始你的圖片追蹤 AR</p>
      <p>點擊下方按鈕授權使用後置相機。對準目標圖卡後，將顯示預設圖片或影片（已預留 3D 模型位置）。</p>
      <div class="row">
        <button id="btnEnterHero" class="btn">進入 AR</button>
        <a href="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card1.jpg" target="_blank" class="btn secondary">下載目標圖</a>
      </div>
      <p>若遇黑畫面：請使用 HTTPS 網址、允許相機權限、更新 Safari/Chrome 至最新版。</p>
    </div>
  </div>

  <!-- Toast 提示 -->
  <div id="toast" class="toast"></div>

  <!-- AR 容器 -->
  <div id="ar-container">
    <a-scene id="ar-scene" mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/targets.mind; autoStart: false; uiScanning: true; uiLoading: true; uiError: true; maxTrack: 1" color-space="sRGB" renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true; antialias: true; precision: mediump; preserveDrawingBuffer: true" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" embedded="">
      <a-assets timeout="120000">
        <!-- 內嵌 SVG 圖片（避免跨域，方便截圖） -->
        <img id="overlayImg" crossorigin="anonymous" src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1024' height='1024'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0' stop-color='%23a78bfa'/%3E%3Cstop offset='1' stop-color='%234f46e5'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100%25' height='100%25' rx='64' fill='url(%23g)'/%3E%3Cg fill='%23fff' font-family='Arial, Helvetica, sans-serif' text-anchor='middle'%3E%3Ctext x='512' y='520' font-size='80' font-weight='700'%3EMindAR Overlay%3C/text%3E%3Ctext x='512' y='600' font-size='40' opacity='0.85'%3E掃描成功！%3C/text%3E%3C/g%3E%3C/svg%3E">
        <!-- 範例影片（若要保證可截圖，建議將影片放在同網域） -->
        <video id="overlayVideo" playsinline webkit-playsinline muted loop preload="auto" crossorigin="anonymous"
          src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/face-animation.mp4"></video>
        <!-- 預留 3D 模型（之後可自行換成你的 .glb/.gltf） -->
        <!-- <a-asset-item id="modelGLB" src="./models/your-model.glb"></a-asset-item> -->
      </a-assets>
      <!-- 必須有一個攝影機 -->
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      <!-- 目標1（對應 targets.mind 的 index: 0）-->
      <a-entity id="target-0" mindar-image-target="targetIndex: 0">
        <!-- 圖片覆蓋 -->
        <a-plane id="img-plane" src="#overlayImg" position="0 0 0" rotation="0 0 0" width="1" height="0.56" visible="true" material="transparent: true; side: double"></a-plane>
        <!-- 影片覆蓋（預設藏起，等找到目標再顯示） -->
        <a-plane id="video-plane" position="0 -0.05 0" rotation="0 0 0" width="1" height="0.56" visible="false"
          material="src: #overlayVideo; transparent: true; side: double"></a-plane>
        <!-- 預留 3D 模型 -->
        <!--
        <a-entity id="model-entity"
                  gltf-model="#modelGLB"
                  position="0 0.1 0" rotation="0 0 0" scale="0.2 0.2 0.2"
                  visible="false"></a-entity>
        -->
      </a-entity>
    </a-scene>
  </div>

  <!-- 下方工具列（AR 啟動後顯示） -->
  <div id="bottombar" class="bottombar">
    <button id="btnSave" class="btn ok">儲存截圖</button>
    <button id="btnToggleVideo" class="btn secondary">切換顯示：影片/圖片</button>
    <button id="btnStop" class="btn danger">離開 AR</button>
  </div>

  <!-- 提示文字 -->
  <div id="tip" class="tip">對準上方「下載目標圖」的卡片試試看 👀</div>

  <!-- 輔助面板 -->
  <div id="helper" class="helper">
    <h3>使用說明 / 除錯</h3>
    <ul>
      <li>請使用 <a href="https://https.cio.gov/" target="_blank" class="link">HTTPS</a> 網址（或本機 HTTPS 伺服器），否則相機可能無法啟動。</li>
      <li>首次進入請「允許相機權限」。若不小心拒絕，請到瀏覽器設定重設權限。</li>
      <li>影片在 iOS 需靜音才能自動播放，已強制 <code>mute</code> + <code>playsinline</code>。</li>
      <li>若截圖失敗：請將影片和圖片素材放在同網域（避免 CORS 汙染）。</li>
      <li>測試目標圖：<a href="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card1.jpg" target="_blank" class="link">點此開啟</a></li>
    </ul>
    <button id="btnCloseHelp" class="btn ghost">關閉</button>
  </div>

  <script>
    // 小工具：Toast 提示
    const toastEl = document.getElementById('toast');
    function toast(msg, type='ok', timeout=2200) {
      toastEl.textContent = msg;
      toastEl.className = `toast show ${type}`;
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=> toastEl.className = 'toast', timeout);
    }

    // 元素
    const sceneEl   = document.getElementById('ar-scene');
    const heroEl    = document.getElementById('hero');
    const tipEl     = document.getElementById('tip');
    const bottomEl  = document.getElementById('bottombar');
    const btnEnter  = document.getElementById('btnEnter');
    const btnEnterHero = document.getElementById('btnEnterHero');
    const btnSave   = document.getElementById('btnSave');
    const btnStop   = document.getElementById('btnStop');
    const btnToggleVideo = document.getElementById('btnToggleVideo');
    const btnHelp   = document.getElementById('btnHelp');
    const helperEl  = document.getElementById('helper');
    const btnCloseHelp = document.getElementById('btnCloseHelp');

    const target0El = document.getElementById('target-0');
    const videoEl   = document.getElementById('overlayVideo');
    const videoPlane= document.getElementById('video-plane');
    const imgPlane  = document.getElementById('img-plane');

    // 狀態
    let arRunning = false;
    let showVideo = false;

    // 黑畫面預防 1：開啟前檢查 HTTPS 與 API 支援
    function preflightCheck() {
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        toast('建議使用 HTTPS，否則相機可能無法啟動', 'warn', 3000);
      }
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        toast('此設備/瀏覽器不支援相機', 'err', 4000);
        throw new Error('mediaDevices.getUserMedia not supported');
      }
      const gl2 = document.createElement('canvas').getContext('webgl2');
      if (!gl2) {
        toast('此設備不支援 WebGL2，MindAR 可能無法啟動', 'warn', 4000);
      }
    }

    // 啟動 AR
    async function startAR() {
      if (arRunning) return;
      preflightCheck();

      const arSystem = sceneEl.systems['mindar-image-system'];
      try {
        // iOS 影片自動播放需在手勢中預先 play（muted）
        try { await videoEl.play(); } catch(e) { /* 忽略 */ }

        await arSystem.start(); // MindAR 啟動
        heroEl.style.display = 'none'; // 授權成功後立即隱藏首屏，進入 AR 視圖
        await readyPromise; // 等待 arReady
        arRunning = true;

        // 顯示控制列
        bottomEl.style.display = 'flex';
        tipEl.style.display = 'block';
        toast('AR 已啟動', 'ok');

        // 防止 Safari 把相機當成全螢幕影片
        if (arSystem.video) {
          arSystem.video.setAttribute('playsinline', 'true');
          arSystem.video.setAttribute('webkit-playsinline', 'true');
        }
      } catch (err) {
        console.error(err);
        heroEl.style.display = 'grid'; // 錯誤時恢復首屏
        toast('AR 啟動失敗：' + (err.message || err.toString()), 'err', 4000);
      }
    }

    // 停止 AR
    async function stopAR() {
      if (!arRunning) return;
      const arSystem = sceneEl.systems['mindar-image-system'];
      await arSystem.stop();
      arRunning = false;
      bottomEl.style.display = 'none';
      tipEl.style.display = 'none';
      heroEl.style.display = 'grid';
      // 停止影片播放
      try { videoEl.pause(); } catch(e) {}
      toast('AR 已關閉', 'ok');
    }

    // 截圖（包含相機背景與 3D 物件）
    async function saveSnapshot() {
      const renderer = sceneEl.renderer;
      if (!renderer || !renderer.domElement) {
        toast('截圖失敗：Renderer 未就緒', 'err'); return;
      }

      // 若顯示了跨域影片材質，Canvas 會被汙染，這裡先暫時隱藏影片 1~2 frame 以避開
      const wasVideoVisible = videoPlane.getAttribute('visible') === true || videoPlane.getAttribute('visible') === 'true';
      if (wasVideoVisible) {
        videoPlane.setAttribute('visible', false);
        // 等待兩個 animation frame，確保畫面已更新
        await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
      }

      try {
        const dataURL = renderer.domElement.toDataURL('image/png'); // 需要 preserveDrawingBuffer: true
        // 推下載（iOS 有時不支援 download 屬性，備援開新窗）
        const a = document.createElement('a');
        a.href = dataURL; a.download = 'ar-snapshot.png';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);

        // 若瀏覽器阻擋 download，就開新視窗預覽
        setTimeout(() => {
          if (!document.hasFocus()) window.open(dataURL, '_blank');
        }, 300);
        toast('已儲存截圖（若未自動下載，請手動長按另存）', 'ok', 2600);
      } catch (err) {
        console.error(err);
        toast('截圖失敗：可能為跨網域素材導致。請把影片/圖片放同網域。', 'warn', 3600);
      } finally {
        if (wasVideoVisible) {
          videoPlane.setAttribute('visible', true);
        }
      }
    }

    // 切換顯示圖片/影片
    function toggleVideoOrImage() {
      showVideo = !showVideo;
      videoPlane.setAttribute('visible', showVideo);
      imgPlane.setAttribute('visible', !showVideo);
      if (showVideo) {
        try { videoEl.play(); } catch(e) {}
        btnToggleVideo.textContent = '切換顯示：圖片';
      } else {
        try { videoEl.pause(); } catch(e) {}
        btnToggleVideo.textContent = '切換顯示：影片';
      }
    }

    // 綁定事件
    btnEnter.addEventListener('click', startAR);
    btnEnterHero.addEventListener('click', startAR);
    btnStop.addEventListener('click', stopAR);
    btnSave.addEventListener('click', saveSnapshot);
    btnToggleVideo.addEventListener('click', toggleVideoOrImage);

    // 說明面板
    btnHelp.addEventListener('click', ()=> helperEl.classList.add('show'));
    btnCloseHelp.addEventListener('click', ()=> helperEl.classList.remove('show'));

    // 目標偵測事件：找到/失去目標
    target0El.addEventListener('targetFound', () => {
      // 預設顯示圖片，可按按鈕切換影片
      if (showVideo) {
        videoPlane.setAttribute('visible', true);
        try { videoEl.play(); } catch(e) {}
      }
      imgPlane.setAttribute('visible', !showVideo);
    });
    target0El.addEventListener('targetLost', () => {
      // 保守作法：找到目標才顯示，丟失就暫停影片
      try { videoEl.pause(); } catch(e) {}
    });

    // MindAR 全域事件
    let resolveReady;
    const readyPromise = new Promise(r => resolveReady = r);
    sceneEl.addEventListener('arReady', () => {
      console.log('MindAR ready');
      resolveReady();
    });
    sceneEl.addEventListener('arError', (e) => {
      console.error('MindAR error', e);
      heroEl.style.display = 'grid'; // 錯誤時恢復首屏
      toast('AR 啟動錯誤：請確認相機權限與 HTTPS', 'err', 3600);
    });
  </script>
</body>
</html>